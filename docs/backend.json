{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the SiteWise PM application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "role": {
          "type": "string",
          "description": "The role of the user (Admin, PM, Technician)."
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the user."
        },
        "email": {
          "type": "string",
          "description": "The email address of the user.",
          "format": "email"
        }
      },
      "required": [
        "id",
        "role",
        "firstName",
        "lastName",
        "email"
      ]
    },
    "Site": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Site",
      "type": "object",
      "description": "Represents a site managed by the SiteWise PM application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Site entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the site."
        },
        "location": {
          "type": "string",
          "description": "The location of the site."
        }
      },
      "required": [
        "id",
        "name",
        "location"
      ]
    },
    "PmAssignment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PmAssignment",
      "type": "object",
      "description": "Represents the assignment of a PM to a site for a specific week.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the PmAssignment entity."
        },
        "siteId": {
          "type": "string",
          "description": "Reference to Site. (Relationship: Site 1:N PmAssignment)"
        },
        "pmId": {
          "type": "string",
          "description": "Reference to User (PM). (Relationship: User 1:N PmAssignment)"
        },
        "weekStartDate": {
          "type": "string",
          "description": "The start date of the week for which the PM is assigned.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "siteId",
        "pmId",
        "weekStartDate"
      ]
    },
    "Task": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Task",
      "type": "object",
      "description": "Represents a task to be performed during a PM.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Task entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the task."
        },
        "description": {
          "type": "string",
          "description": "A description of the task."
        },
        "type": {
          "type": "string",
          "description": "The type of task (static or dynamic)."
        },
        "siteId": {
          "type": "string",
          "description": "Reference to Site if it is a dynamic task. Null if static. (Relationship: Site 1:N Task)"
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "type"
      ]
    },
    "PmSession": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PmSession",
      "type": "object",
      "description": "Represents a PM session for a specific site and week.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the PmSession entity."
        },
        "siteId": {
          "type": "string",
          "description": "Reference to Site. (Relationship: Site 1:N PmSession)"
        },
        "pmAssignmentId": {
          "type": "string",
          "description": "Reference to PmAssignment. (Relationship: PmAssignment 1:N PmSession)"
        },
        "technicianId": {
          "type": "string",
          "description": "Reference to User (Technician). (Relationship: User 1:N PmSession)"
        },
        "sessionDate": {
          "type": "string",
          "description": "The date of the PM session.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "siteId",
        "pmAssignmentId",
        "technicianId",
        "sessionDate"
      ]
    },
    "TaskResult": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TaskResult",
      "type": "object",
      "description": "Represents the result of a task performed during a PM session.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the TaskResult entity."
        },
        "pmSessionId": {
          "type": "string",
          "description": "Reference to PmSession. (Relationship: PmSession 1:N TaskResult)"
        },
        "taskId": {
          "type": "string",
          "description": "Reference to Task. (Relationship: Task 1:N TaskResult)"
        },
        "description": {
          "type": "string",
          "description": "Text description of the task result."
        },
        "location": {
          "type": "string",
          "description": "GPS location of the task completion."
        },
        "checklistItems": {
          "type": "array",
          "description": "Checklist items associated with the task",
          "items": {
            "type": "string"
          }
        },
        "imageUrl": {
          "type": "array",
          "description": "URL to the image.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "pmSessionId",
        "taskId"
      ]
    },
    "ChangeRequest": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ChangeRequest",
      "type": "object",
      "description": "Represents a change request for a specific site.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ChangeRequest entity."
        },
        "siteId": {
          "type": "string",
          "description": "Reference to Site. (Relationship: Site 1:N ChangeRequest)"
        },
        "description": {
          "type": "string",
          "description": "Description of the change request."
        },
        "priority": {
          "type": "string",
          "description": "Priority of the change request."
        },
        "status": {
          "type": "string",
          "description": "Status of the change request (Open, In Progress, Completed, Rejected)."
        },
        "imageUrl": {
          "type": "string",
          "description": "URL to the image."
        }
      },
      "required": [
        "id",
        "siteId",
        "description",
        "priority",
        "status"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles, secured by path-based ownership. Includes user 'role' for authorization.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/sites/{siteId}",
        "definition": {
          "entityName": "Site",
          "schema": {
            "$ref": "#/backend/entities/Site"
          },
          "description": "Stores site information.  Site admins/PMs are authorized to access its subcollections.",
          "params": [
            {
              "name": "siteId",
              "description": "The unique identifier for the site."
            }
          ]
        }
      },
      {
        "path": "/sites/{siteId}/pmAssignments/{pmAssignmentId}",
        "definition": {
          "entityName": "PmAssignment",
          "schema": {
            "$ref": "#/backend/entities/PmAssignment"
          },
          "description": "Stores PM assignments for each site. Denormalizes 'pmId' for authorization. Requires role PM.",
          "params": [
            {
              "name": "siteId",
              "description": "The unique identifier for the site."
            },
            {
              "name": "pmAssignmentId",
              "description": "The unique identifier for the PM assignment."
            }
          ]
        }
      },
      {
        "path": "/tasks/{taskId}",
        "definition": {
          "entityName": "Task",
          "schema": {
            "$ref": "#/backend/entities/Task"
          },
          "description": "Stores static tasks, common across multiple sites.  Admins are authorized to read and write tasks.",
          "params": [
            {
              "name": "taskId",
              "description": "The unique identifier for the task."
            }
          ]
        }
      },
      {
        "path": "/sites/{siteId}/tasks/{taskId}",
        "definition": {
          "entityName": "Task",
          "schema": {
            "$ref": "#/backend/entities/Task"
          },
          "description": "Stores dynamic tasks, specific to a single site.  Site admins are authorized to manage these tasks.",
          "params": [
            {
              "name": "siteId",
              "description": "The unique identifier for the site."
            },
            {
              "name": "taskId",
              "description": "The unique identifier for the task."
            }
          ]
        }
      },
      {
        "path": "/sites/{siteId}/pmAssignments/{pmAssignmentId}/pmSessions/{pmSessionId}",
        "definition": {
          "entityName": "PmSession",
          "schema": {
            "$ref": "#/backend/entities/PmSession"
          },
          "description": "Stores PM sessions for a specific site and week. Denormalizes authorization data. Requires role PM or technician.",
          "params": [
            {
              "name": "siteId",
              "description": "The unique identifier for the site."
            },
            {
              "name": "pmAssignmentId",
              "description": "The unique identifier for the PM assignment."
            },
            {
              "name": "pmSessionId",
              "description": "The unique identifier for the PM session."
            }
          ]
        }
      },
      {
        "path": "/sites/{siteId}/pmAssignments/{pmAssignmentId}/pmSessions/{pmSessionId}/taskResults/{taskResultId}",
        "definition": {
          "entityName": "TaskResult",
          "schema": {
            "$ref": "#/backend/entities/TaskResult"
          },
          "description": "Stores the results of tasks performed during a PM session. Requires role PM or technician.",
          "params": [
            {
              "name": "siteId",
              "description": "The unique identifier for the site."
            },
            {
              "name": "pmAssignmentId",
              "description": "The unique identifier for the PM assignment."
            },
            {
              "name": "pmSessionId",
              "description": "The unique identifier for the PM session."
            },
            {
              "name": "taskResultId",
              "description": "The unique identifier for the task result."
            }
          ]
        }
      },
      {
        "path": "/sites/{siteId}/changeRequests/{changeRequestId}",
        "definition": {
          "entityName": "ChangeRequest",
          "schema": {
            "$ref": "#/backend/entities/ChangeRequest"
          },
          "description": "Stores change requests for each site. Requires role PM or Admin.",
          "params": [
            {
              "name": "siteId",
              "description": "The unique identifier for the site."
            },
            {
              "name": "changeRequestId",
              "description": "The unique identifier for the change request."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore database structure is designed to support the SiteWise PM application's requirements for managing sites, PM assignments, tasks, PM sessions, task results, and change requests, while adhering to the core design principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters). It leverages denormalization and structural segregation to simplify security rules and ensure data integrity.\n\n**Authorization Independence:**\n\n*   **User Roles:** User roles (`Admin`, `PM`, `Technician`) are stored directly within the `users` document, enabling role-based access control without requiring complex `get()` calls to other collections.\n*   **Site Ownership (Hypothetical):** If sites had explicit owners, the `ownerId` would be denormalized into subcollections like `pmAssignments` and `changeRequests`. Currently, the system provides no role-based access to the site document.\n*   **PmAssignment:** Denormalizes `pmId` to facilitate direct access based on the current user.\n\n**Structural Segregation:**\n\n*   **Tasks:** Static tasks are stored in the `/tasks` collection, while dynamic tasks are stored in `/sites/{siteId}/tasks`. This segregation simplifies security rules, allowing different access controls for each task type.\n\n**Access Modeling:**\n\n*   **Users:** Private data, secured by path-based ownership (`/users/{userId}`).\n*   **Sites:** Sites are stored in a top-level collection (`/sites`).  Access to sites and their related data is implicitly managed by role-based access (Admin/PM) enforced via security rules (not explicitly modeled in the data structure, given requirements).\n*   **User Owned Data:** The `PmAssignment` is located at `/sites/{siteId}/pmAssignments/{pmAssignmentId}` and associated to a PM `pmId`.\n*   **Nested Data:** The `TaskResult` and `ChangeRequest` entities continue to build on the data hierarchy.\n*   **Global Roles (DBAC):** The role of the user is located in the `/users/{userId}` document.\n\n**QAPs (Rules are not Filters):**\n\n*   The data structure promotes secure `list` operations. For example, listing PM assignments for a site can be achieved by querying the `/sites/{siteId}/pmAssignments` collection. This structure avoids filtering on the client side.\n\n**Invariants:**\n\n*   The structure supports data integrity through clear ownership (where applicable) and explicit relationships between entities, as well as enables security rules to enforce timestamp consistency and prevent data manipulation by unauthorized users. The separation of dynamic and static tasks maintains task type integrity."
  }
}